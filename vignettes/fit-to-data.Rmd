---
title: "fit-to-data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{fit-to-data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(mmmstan)
```

# Fit model
```{r fit-model}

if (FALSE) {
  # Define tag paths
  path_released <- "~/github/sablefish-data/data/tags_released.rda"
  path_recovered <- "~/github/sablefish-data/data/tags_recovered.rda"
  # Assign values
  tags_released <- read_from_path(path = path_released)
  tags_recovered <- read_from_path(path = path_recovered)
  # Tags
  tag_data <- tags_released %>%
    dplyr::left_join(
      tags_recovered,
      by = c(
        "tag_id", 
        "released_date", 
        "released_length", 
        "released_region", 
        "released_omregion", 
        "source"
      )
    )
  # Region arguments -----------------------------------------------------------
  
  # # Eight regions
  # list_regions <- list(ai = 1, bs = 2, wg = 3, cg = 4, eg = 5, se = 6, bc = 7, cc = 8)
  # movement_pattern <- 2
  # movement_allow <- matrix(c(5, 7, 7, 5), nrow = 2, byrow = TRUE)
  # movement_disallow <- NULL
  
  # Three regions
  list_regions <- list(ak = 1:6, bc = 7, cc = 8)
  movement_pattern <- 2
  movement_allow <- NULL
  movement_disallow <- NULL
  
  # Step arguments -------------------------------------------------------------
  
  step_interval <- "month"
  # step_liberty_max <- NULL
  step_liberty_max <- 36

  # Terms unique movement ------------------------------------------------------
  
  term_interval <- "quarter"

  # Rate arguments -------------------------------------------------------------
  
  rate_interval <- "year"
  
  # Size arguments -------------------------------------------------------------
  
  # list_sizes <- list(s = 400:499, m = 500:599, l = 600:699, xl = 700:799)
  # list_sizes <- list(s = 400:549, l = 550:799)
  list_sizes <- list(sml = 400:799)
  
  # Arguments ------------------------------------------------------------------
  
  year_released_start <- 1979
  year_recovered_end <- 2015 # Go to 2017 with present data
  colname_date_released <- "released_date" # "date_released"
  colname_date_recovered <- "recovered_date" # "date_recovered"
  colname_region_released <- "released_region" # "region_released"
  colname_region_recovered <- "recovered_region" # "region_recovered"
  colname_size_released <- "released_length" # "size_released"
  mu_fishing_rate <- array(
    0.1, 
    dim = c(
      year_recovered_end - year_released_start + 1L,
      length(list_regions)
    ) 
  )
  mu_mortality_rate <- rep(0.1, length(list_regions))
  mu_reporting_rate <- rep(1, length(list_regions))
  mu_selectivity <- rep(1, length(list_sizes) - 1L)
  mu_initial_loss_rate <- 0.1
  mu_ongoing_loss_rate <- 0.02
  mu_dispersion <- 1
  cv_fishing_rate <- 0.01
  cv_mortality_rate <- 0.01
  cv_reporting_rate <- 0.1
  cv_selectivity <- 0.1
  cv_initial_loss_rate <- 0.1
  cv_ongoing_loss_rate <- 0.1
  cv_movement_deviation <- 0.1
  cv_dispersion <- 0.25
  tolerance_expected <- 1e-12
  tolerance_movement <- 1e-12
  tolerance_fishing <- 1e-6
  data <- NULL
  chains <- 1
  step_size <- 0.01
  adapt_delta <- 0.8
  iter_warmup <- 250
  iter_sampling <- 750
  use_reduce_sum <- FALSE
  threads_per_chain <- parallel::detectCores() / 2
  refresh <- 10
  
  # Fit ------------------------------------------------------------------------
  
  fit <- mmmstan(
    tag_data = tag_data,
    list_regions = list_regions,
    list_sizes = list_sizes,
    year_released_start = year_released_start,
    year_recovered_end = year_recovered_end,
    step_interval = step_interval,
    step_liberty_max = step_liberty_max,
    term_interval = term_interval,
    rate_interval = rate_interval,
    colname_date_released = colname_date_released, # "date_released",
    colname_date_recovered = colname_date_recovered, # "date_recovered",
    colname_region_released = colname_region_released, # "region_released",
    colname_region_recovered = colname_region_recovered, # "region_recovered",
    colname_size_released = colname_size_released, # "size_released",
    movement_pattern = movement_pattern,
    movement_allow = movement_allow,
    movement_disallow = movement_disallow,
    mu_fishing_rate = mu_fishing_rate,
    mu_mortality_rate = mu_mortality_rate,
    mu_reporting_rate = mu_reporting_rate,
    mu_selectivity = mu_selectivity,
    mu_initial_loss_rate = mu_initial_loss_rate,
    mu_ongoing_loss_rate = mu_ongoing_loss_rate,
    mu_dispersion = mu_dispersion,
    cv_fishing_rate = cv_fishing_rate,
    cv_mortality_rate = cv_mortality_rate,
    cv_reporting_rate = cv_reporting_rate,
    cv_selectivity = cv_selectivity,
    cv_initial_loss_rate = cv_initial_loss_rate,
    cv_ongoing_loss_rate = cv_ongoing_loss_rate,
    cv_movement_deviation = cv_movement_deviation,
    cv_dispersion = cv_dispersion,
    tolerance_expected = tolerance_expected,
    tolerance_movement = tolerance_movement,
    tolerance_fishing = tolerance_fishing,
    chains = chains,
    step_size = step_size,
    adapt_delta = adapt_delta,
    iter_warmup = iter_warmup,
    iter_sampling = iter_sampling,
    use_reduce_sum = use_reduce_sum,
    threads_per_chain = threads_per_chain,
    refresh = refresh)
    # View
    tibble::view(fit$summary$movement_rate)
    # Plot
    plot(fit)
  }

```
