---
title: "fit-to-data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{fit-to-data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(mmmstan)
```

# Load data
```{r load-data}
if (FALSE) {
  # Define tag paths
  path_released <- "~/github/sablefish-data/data/tags_released.rda"
  path_recovered <- "~/github/sablefish-data/data/tags_recovered.rda"
  # Assign values
  tags_released <- read_from_path(path = path_released)
  tags_recovered <- read_from_path(path = path_recovered)
  # Tags
  tag_data <- tags_released %>%
    dplyr::left_join(
      tags_recovered,
      by = c(
        "tag_id", 
        "released_date", 
        "released_length", 
        "released_region", 
        "released_omregion", 
        "source"
      )
    )
  
  # Region arguments -----------------------------------------------------------
  
  # # Eight regions
  # list_regions <- list(ai = 1, bs = 2, wg = 3, cg = 4, eg = 5, se = 6, bc = 7, cc = 8)
  # movement_pattern <- 2
  # movement_allow <- matrix(c(5, 7, 7, 5), nrow = 2, byrow = TRUE)
  # movement_disallow <- NULL
  
  # Three regions
  list_regions <- list(ak = 1:6, bc = 7, cc = 8)
  movement_pattern <- 2
  movement_allow <- NULL
  movement_disallow <- NULL
  
  # Step arguments -------------------------------------------------------------
  
  step_interval <- "quarter"
  # step_liberty_max <- NULL
  step_liberty_max <- 12
  
  # Size arguments -------------------------------------------------------------
  
  # For fit mean
  list_sizes <- list(sml = 400:800)
  # For fit size
  list_sizes_small_large <- list(s = 400:549, l = 550:800)
 
  # Year arguments -------------------------------------------------------------
  
  year_start <- 1979
  year_end <- 2017
  
  # Column name arguments ------------------------------------------------------
  
  colname_date_released <- "released_date" # "date_released"
  colname_date_recovered <- "recovered_date" # "date_recovered"
  colname_region_released <- "released_region" # "region_released"
  colname_region_recovered <- "recovered_region" # "region_recovered"
  colname_size_released <- "released_length" # "size_released"
  
  # Use reduce sum -------------------------------------------------------------
  
  use_reduce_sum <- FALSE
  # use_reduce_sum <- TRUE
  refresh = 10
}

```

# Fit mean
```{r fit-mean}
if (FALSE) {
  # Fit mean
  fit_mean <- mmmstan(
    tag_data = tag_data,
    model_form = "mean",
    # Tag arguments
    list_regions = list_regions,
    list_sizes = list_sizes,
    year_start = year_start,
    year_end = year_end,
    step_interval = step_interval,
    step_liberty_max = step_liberty_max,
    colname_date_released = colname_date_released, # "date_released",
    colname_date_recovered = colname_date_recovered, # "date_recovered",
    colname_region_released = colname_region_released, # "region_released",
    colname_region_recovered = colname_region_recovered, # "region_recovered",
    colname_size_released = colname_size_released, # "size_released",
    # Movement index
    movement_pattern = movement_pattern,
    movement_allow = movement_allow,
    movement_disallow = movement_disallow,
    # Use reduce sum
    use_reduce_sum = use_reduce_sum,
    refresh = refresh
  )
  # View
  tibble::view(fit_mean$summary$movement_step)
  tibble::view(fit_mean$summary$movement_mean)
  tibble::view(fit_mean$summary$fishing_rate)
  # Plot
  ggplot2::ggplot(
    data = fit_mean$summary$movement_mean,
    mapping = ggplot2::aes(
      x = 1,
      y = .data$mean
    )
  ) +
    ggplot2::geom_col() +
    ggplot2::facet_grid(
      rows = ggplot2::vars(.data$x),
      cols = ggplot2::vars(.data$y)
    ) +
    ggsidekick::theme_sleek()
}

```

# Fit time
```{r fit-time}
if (FALSE) {
  # Fit time
  fit_time <- mmmstan(
    tag_data = tag_data,
    model_form = "time",
    # Tag arguments
    list_regions = list_regions,
    list_sizes = list_sizes,
    year_start = year_start,
    year_end = year_end,
    step_interval = step_interval,
    step_liberty_max = step_liberty_max,
    colname_date_released = colname_date_released, # "date_released",
    colname_date_recovered = colname_date_recovered, # "date_recovered",
    colname_region_released = colname_region_released, # "region_released",
    colname_region_recovered = colname_region_recovered, # "region_recovered",
    colname_size_released = colname_size_released, # "size_released",
    # Movement index
    movement_pattern = movement_pattern,
    movement_allow = movement_allow,
    movement_disallow = movement_disallow,
    # Movement step mean priors (from fit mean)
    mu_movement_step_mean = fit_mean$priors$mu_movement_step_mean,
    sd_movement_step_mean = fit_mean$priors$sd_movement_step_mean,
    # Use reduce sum
    use_reduce_sum = use_reduce_sum,
    refresh = refresh
  )
  # View
  tibble::view(fit_time$summary$movement_step)
  tibble::view(fit_time$summary$movement_time)
  tibble::view(fit_time$summary$fishing_rate)
  tibble::view(fit_time$summary$autoregress)
  tibble::view(fit_time$summary$sigma)
  # Plot
  ggplot2::ggplot(
    data = fit_time$summary$movement_time,
    mapping = ggplot2::aes(
      x = .data$i,
      y = .data$mean
    )
  ) +
    ggplot2::geom_col() +
    ggplot2::facet_grid(
      rows = ggplot2::vars(.data$x),
      cols = ggplot2::vars(.data$y)
    ) +
    ggsidekick::theme_sleek()
}

```

# Fit term
```{r fit-term}
if (FALSE) {
  # Fit term
  fit_term <- mmmstan(
    tag_data = tag_data,
    model_form = "term",
    # Tag arguments
    list_regions = list_regions,
    list_sizes = list_sizes,
    year_start = year_start,
    year_end = year_end,
    step_interval = step_interval,
    step_liberty_max = step_liberty_max,
    colname_date_released = colname_date_released, # "date_released",
    colname_date_recovered = colname_date_recovered, # "date_recovered",
    colname_region_released = colname_region_released, # "region_released",
    colname_region_recovered = colname_region_recovered, # "region_recovered",
    colname_size_released = colname_size_released, # "size_released",
    # Movement index
    movement_pattern = movement_pattern,
    movement_allow = movement_allow,
    movement_disallow = movement_disallow,
    # Movement step mean priors (from fit mean)
    mu_movement_step_mean = fit_mean$priors$mu_movement_step_mean,
    sd_movement_step_mean = fit_mean$priors$sd_movement_step_mean,
    # Use reduce sum
    use_reduce_sum = use_reduce_sum,
    refresh = refresh
  )
  # View
  tibble::view(fit_term$summary$movement_step)
  tibble::view(fit_term$summary$movement_term)
  tibble::view(fit_term$summary$fishing_rate)
  tibble::view(fit_term$summary$autoregress)
  tibble::view(fit_term$summary$sigma)
  # Plot
  ggplot2::ggplot(
    data = fit_term$summary$movement_term,
    mapping = ggplot2::aes(
      x = .data$i,
      y = .data$mean
    )
  ) +
    ggplot2::geom_col() +
    ggplot2::facet_grid(
      rows = ggplot2::vars(.data$x),
      cols = ggplot2::vars(.data$y)
    ) +
    ggsidekick::theme_sleek()
}

```

# Fit size
```{r fit-size}
if (FALSE) {
  # Fit size
  fit_size <- mmmstan(
    tag_data = tag_data,
    model_form = "size",
    # Tag arguments
    list_regions = list_regions,
    list_sizes = list_sizes_small_large,
    year_start = year_start,
    year_end = year_end,
    step_interval = step_interval,
    step_liberty_max = step_liberty_max,
    colname_date_released = colname_date_released, # "date_released",
    colname_date_recovered = colname_date_recovered, # "date_recovered",
    colname_region_released = colname_region_released, # "region_released",
    colname_region_recovered = colname_region_recovered, # "region_recovered",
    colname_size_released = colname_size_released, # "size_released",
    # Movement index
    movement_pattern = movement_pattern,
    movement_allow = movement_allow,
    movement_disallow = movement_disallow,
    # Use reduce sum
    use_reduce_sum = use_reduce_sum,
    refresh = refresh
  )
  # View
  tibble::view(fit_size$summary$movement_step)
  tibble::view(fit_size$summary$movement_size)
  tibble::view(fit_size$summary$fishing_rate)
  tibble::view(fit_size$summary$autoregress)
  tibble::view(fit_size$summary$sigma)
  # Plot
  ggplot2::ggplot(
    data = fit_size$summary$movement_size,
    mapping = ggplot2::aes(
      x = .data$d,
      y = .data$mean
    )
  ) +
    ggplot2::geom_col() +
    ggplot2::facet_grid(
      rows = ggplot2::vars(.data$x),
      cols = ggplot2::vars(.data$y)
    ) +
    ggsidekick::theme_sleek()
}

```


