---
title: "fit-to-data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{fit-to-data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(mmmstan)
```

# Prepare Data
```{r prepare-data}

if (FALSE) {
  # Define tag paths
  path_released <- "~/github/sablefish-data/data/tags_released.rda"
  path_recovered <- "~/github/sablefish-data/data/tags_recovered.rda"
  # Assign values
  tags_released <- read_from_path(path = path_released)
  tags_recovered <- read_from_path(path = path_recovered)
  # Tags
  tag_data <- tags_released %>%
    dplyr::left_join(
      tags_recovered,
      by = c(
        "tag_id", 
        "released_date", 
        "released_length", 
        "released_region", 
        "released_omregion", 
        "source"
      )
    )
  # Arguments
    tag_data <- tag_data
    list_regions <- list(ai = 1, bs = 2, wg = 3, cg = 4, eg = 5, se = 6, bc = 7, cc = 8)
    list_sizes <- list(s = 400:499, m = 500:599, l = 600:699, xl = 700:799)
    date_released_start <- "1979-01-01"
    date_released_end <- "2015-12-31"
    step_liberty_max <- NULL
    term_released <- "quarter"
    colname_date_released <- "released_date" # "date_released"
    colname_date_recovered <- "recovered_date" # "date_recovered"
    colname_region_released <- "released_region" # "region_released"
    colname_region_recovered <- "recovered_region" # "region_recovered"
    colname_size_released <- "released_length" # "size_released"
    movement_pattern <- 2
    movement_allow <- matrix(c(5, 7, 7, 5), nrow = 2, byrow = TRUE)
    movement_disallow <- NULL
    mu_mortality_rate <- rep(0.1, length(list_regions))
    mu_reporting_rate <- rep(1, length(list_regions))
    mu_fishing_mean_rate <- rep(0.1, length(list_regions))
    mu_initial_loss_rate <- 0.1
    mu_ongoing_loss_rate <- 0.02
    mu_dispersion <- 1
    mu_fishing_deviation_time_rate <- NULL
    sd_mortality_rate <- 0.1 * mu_mortality_rate
    sd_reporting_rate <- 0.1 * mu_reporting_rate
    sd_fishing_mean_rate <- 0.1 * mu_fishing_mean_rate
    sd_initial_loss_rate <- 0.1 * mu_initial_loss_rate
    sd_ongoing_loss_rate <- 0.1 * mu_ongoing_loss_rate
    sd_dispersion <- 0.25 * mu_dispersion
    cv_movement_deviation_time_rate <- 0.1
    cv_movement_deviation_term_rate <- 0.1
    cv_movement_deviation_size_rate <- 0.1
    cv_fishing_deviation_time_rate <- 0.1
    cv_fishing_deviation_term_rate <- 0.1
    cv_fishing_deviation_size_rate <- 0.1
    expected_fudge <- 1e-12
    data <- NULL
    chains <- 1
    step_size <- 0.01
    iter_warmup <- 250
    iter_sampling <- 750
    use_reduce_sum <- FALSE
    threads_per_chain <- 8  
  # Fit
  m1 <- fit(
    tag_data = tag_data,
    list_regions = list(ai = 1, bs = 2, wg = 3, cg = 4, eg = 5, se = 6, bc = 7, cc = 8),
    list_sizes = list(s = 400:499, m = 500:599, l = 600:699, xl = 700:799),
    date_released_start = "1979-01-01",
    date_released_end = "2015-12-31",
    step_liberty_max = NULL,
    term_released = "quarter",
    colname_date_released = "released_date", # "date_released",
    colname_date_recovered = "recovered_date", # "date_recovered",
    colname_region_released = "released_region", # "region_released",
    colname_region_recovered = "recovered_region", # "region_recovered",
    colname_size_released = "released_length", # "size_released",
    movement_pattern = 2,
    movement_allow = matrix(c(5, 7, 7, 5), nrow = 2, byrow = TRUE),
    movement_disallow = NULL,
    mu_mortality_rate = rep(0.1, length(list_regions)),
    mu_reporting_rate = rep(1, length(list_regions)),
    mu_fishing_mean_rate = rep(0.1, length(list_regions)),
    mu_initial_loss_rate = 0.1,
    mu_ongoing_loss_rate = 0.02,
    mu_dispersion = 1,
    mu_fishing_deviation_time_rate = NULL,
    sd_mortality_rate = 0.1 * mu_mortality_rate,
    sd_reporting_rate = 0.1 * mu_reporting_rate,
    sd_fishing_mean_rate = 0.1 * mu_fishing_mean_rate,
    sd_initial_loss_rate = 0.1 * mu_initial_loss_rate,
    sd_ongoing_loss_rate = 0.1 * mu_ongoing_loss_rate,
    sd_dispersion = 0.25 * mu_dispersion,
    cv_movement_deviation_time_rate = 0.1,
    cv_movement_deviation_term_rate = 0.1,
    cv_movement_deviation_size_rate = 0.1,
    cv_fishing_deviation_time_rate = 0.1,
    cv_fishing_deviation_term_rate = 0.1,
    cv_fishing_deviation_size_rate = 0.1,
    expected_fudge = 1e-12,
    data = NULL,
    chains = 1,
    step_size = 0.01,
    iter_warmup = 250,
    iter_sampling = 750,
    use_reduce_sum = FALSE,
    threads_per_chain = 8)
  }


# 
# if (FALSE) {
#   load("~/github/sablefish-data/data/tags_released.rda")
#   load("~/github/sablefish-data/data/tags_recovered.rda")
# }
# 
# if (FALSE) {
#   area_list <- list(bs = 1, ai = 2, wg = 3, cg = 4, eg = 5,
#                     se = 6, bc = 7, cc = 8)
# }
# 
# if (FALSE) {
#   # Quarterly
#   tags <- tag_arrays(
#     released = tags_released,
#     recovered = tags_recovered,
#     released_time_unit = "quarter",
#     released_time_max = 148,
#     liberty_time_max = 12,
#     liberty_days_min = 30, # Not implemented
#     colname_released_date = "released_date",
#     colname_released_area = "released_region",
#     colname_group = "released_length",
#     colname_recovered_date = "recovered_date",
#     colname_recovered_area = "recovered_region",
#     colname_id = "tag_id",
#     area_list = area_list,
#     group_list = list(pooled = 400:799),
#     released_date_start = "1979-01-01",
#     released_date_end = "2015-12-31"
#   ) 
# }

```

# Quarterly fit three F
```{r quarterly-fit-three-f}

# if (FALSE) {
#   h_prior_mean <- array(0.05, dim = c(1, 1, 8))
#   h_prior_sd <- 0.1 * h_prior_mean
# }
# 
# if (FALSE) {
#   # Define data
#   data_list <- list(
#     A = 8,
#     G_released = 1,
#     G_harvest = 1,
#     T_released = 148,
#     T_liberty = 12, # 160,
#     T_study = 148 + 12 - 1, # T_released + T_liberty - 1
#     T_movement = 1,
#     T_harvest = 1,
#     T_reporting = 1,
#     T_year = 4,
#     m = 0.1,
#     u = 0.9,
#     v = 0.02,
#     w = array(1, dim = c(1, 8)),
#     x = tags$x,
#     y = tags$y,
#     z = movement_index(
#       n = 8,
#       pattern = 0,
#       allow = matrix(c(5, 7, 7, 5), nrow = 2, byrow = TRUE)
#     ),
#     p_time_index = rep(1, 159),
#     # p_time_index = rep(1, 160),
#     h_time_index = rep(1, 159), #   rep(1:40, each = 4)[1:(160)],
#     # h_time_index = c(1:(148 + 12 - 1)),
#     w_time_index = rep(1, 159), # Reporting rate time step index
#     h_group_index = array(rep(1, 1), dim = c(1)), # Harvest rate group index
#     random_walk = 0,
#     h_prior_mean = h_prior_mean,
#     h_prior_sd = h_prior_sd,
#     phi_prior_mean = 0.6,
#     phi_prior_sd = 0.2,
#     sigma_prior_mean = numeric(0),
#     sigma_prior_sd = numeric(0),
#     p_fudge = 1e-12,
#     y_fudge = 1e-12
#   )  
# }
# 
# if (FALSE) {
#   # Fit model
#   m1 <- mmmfit(data = data_list, threads_per_chain = 1)
# }
# 
# if (FALSE) {
#   # Fit model
#   m2 <- mmmfit(data = data_list, threads_per_chain = 8, use_reduce_sum = TRUE)
# }

```
